<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Audio Player</title>
    <script src="https://unpkg.com/wavesurfer.js"></script>
    <script src="https://unpkg.com/wavesurfer.js/dist/plugin/wavesurfer.regions.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #1f2937;
        color: white;
        margin: 0;
        padding: 0;
      }
      .playlist-container, .track-item {
        background-color: #374151;
        margin-bottom: 0.25rem;
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        cursor: pointer;
      }
      .track-item.active {
        background-color: #10b981;
        color: black;
        font-weight: bold;
      }
      .track-item.loading {
        background-color: #6b7280 !important;
        position: relative;
      }
      .track-item.loading::after {
        content: '';
        position: absolute;
        right: 1rem;
        top: 50%;
        width: 1rem;
        height: 1rem;
        margin-top: -0.5rem;
        border: 2px solid white;
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div id="app" class="max-w-3xl mx-auto py-8 px-4"></div>

    <script>
      const app = document.getElementById('app');
      let wavesurfer;
      let currentPlaylist = null;
      let currentTrack = null;
      const MAX_RETRIES = 5;
      const TIMEOUT = 3000;

      async function fetchPlaylists() {
        const response = await fetch('files.json');
        return await response.json();
      }

      function createPlaylistView(playlists) {
        app.innerHTML = '';
        playlists.forEach((playlist, index) => {
          const div = document.createElement('div');
          div.className = 'track-item active';
          div.textContent = playlist.playlist;
          div.onclick = () => showPlaylist(playlist, playlists);
          app.appendChild(div);
        });
      }

      function showPlaylist(playlist, allPlaylists) {
        currentPlaylist = playlist;
        app.innerHTML = '';

        const container = document.createElement('div');
        container.className = 'playlist-container';

        const title = document.createElement('h2');
        title.className = 'text-xl font-bold mb-2';
        title.textContent = playlist.playlist;
        container.appendChild(title);

        const waveform = document.createElement('div');
        waveform.id = 'waveform';
        waveform.className = 'w-full h-24 bg-gray-800 rounded mb-4';
        container.appendChild(waveform);

        const controls = document.createElement('div');
        controls.className = 'flex items-center space-x-4 mb-4';

        const playBtn = document.createElement('button');
        playBtn.textContent = 'Play';
        playBtn.className = 'bg-gray-600 px-4 py-2 rounded hover:bg-gray-500';
        playBtn.onclick = () => wavesurfer.playPause();
        controls.appendChild(playBtn);

        container.appendChild(controls);

        const trackList = document.createElement('div');
        playlist.tracks.forEach((track, idx) => {
          const trackDiv = document.createElement('div');
          trackDiv.className = 'track-item';
          trackDiv.textContent = track.title;
          trackDiv.onclick = () => loadTrack(trackDiv, track.file, track.title, playlist.tracks, idx);
          trackList.appendChild(trackDiv);
        });

        container.appendChild(trackList);
        app.appendChild(container);

        // Show only one link: "PLAYLISTS"
        const backToList = document.createElement('div');
        backToList.className = 'track-item active inline-block px-4 py-2';
        backToList.style.cursor = 'pointer';
        backToList.textContent = 'PLAYLISTS';
        backToList.onclick = () => location.reload();
        app.appendChild(backToList);

        // Init player
        wavesurfer = WaveSurfer.create({
          container: '#waveform',
          waveColor: '#9ca3af',
          progressColor: '#10b981',
          height: 80,
          responsive: true
        });
      }

      function loadTrack(element, url, title, trackList, index) {
        document.querySelectorAll('.track-item').forEach(el => {
          el.classList.remove('active', 'loading');
        });
        element.classList.add('loading');

        let attempts = 0;

        function tryLoad() {
          if (wavesurfer) {
            wavesurfer.destroy();
          }
          wavesurfer = WaveSurfer.create({
            container: '#waveform',
            waveColor: '#9ca3af',
            progressColor: '#10b981',
            height: 80,
            responsive: true
          });

          wavesurfer.load(url);

          const timeoutId = setTimeout(() => {
            if (!wavesurfer.isReady && attempts < MAX_RETRIES) {
              attempts++;
              tryLoad();
            }
          }, TIMEOUT);

          wavesurfer.on('ready', () => {
            clearTimeout(timeoutId);
            document.querySelectorAll('.track-item').forEach(el => el.classList.remove('active', 'loading'));
            element.classList.add('active');
            wavesurfer.play();
          });

          wavesurfer.on('error', () => {
            if (attempts < MAX_RETRIES) {
              attempts++;
              tryLoad();
            }
          });
        }

        tryLoad();
      }

      fetchPlaylists().then(createPlaylistView);
    </script>
  </body>
</html>
