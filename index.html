<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Audio Player</title>
  <script src="https://unpkg.com/wavesurfer.js"></script>
  <script src="https://unpkg.com/wavesurfer.js/dist/plugin/wavesurfer.timeline.min.js"></script>
  <script src="https://unpkg.com/wavesurfer.js/dist/plugin/wavesurfer.cursor.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .track:hover { background-color: #4b5563; }
    .track.active { background-color: #047857; }
    .playlist-link {
      background-color: #047857;
      color: white;
      padding: 0.5rem 1rem;
      margin-bottom: 0.25rem;
      cursor: pointer;
    }
    .playlist-link:hover {
      background-color: #065f46;
    }
  </style>
</head>
<body class="bg-gray-900 text-white font-sans">
  <div class="max-w-4xl mx-auto py-8 px-4">
    <div id="playlist-selector" class="mb-8"></div>
    <div id="active-playlist"></div>
    <div id="other-playlists" class="mt-8"></div>
  </div>

  <script>
    async function loadFiles() {
      const res = await fetch('files.json');
      return await res.json();
    }

    function createPlaylist(title, tracks) {
      const container = document.createElement('div');
      const header = document.createElement('div');
      header.className = 'flex items-center justify-between mb-4';
      const titleEl = document.createElement('h2');
      titleEl.className = 'text-2xl font-bold';
      titleEl.textContent = title;
      header.appendChild(titleEl);
      container.appendChild(header);

      const waveform = document.createElement('div');
      waveform.className = 'waveform h-24 bg-gray-800 mb-4';
      container.appendChild(waveform);

      const progress = document.createElement('div');
      progress.className = 'h-1 bg-green-500 w-0 transition-all duration-200';
      container.appendChild(progress);

      const trackList = document.createElement('div');
      trackList.className = 'space-y-2';
      container.appendChild(trackList);

      let wavesurfer = null;
      let current = null;

      tracks.forEach((track, index) => {
        const el = document.createElement('div');
        el.className = 'track p-2 cursor-pointer rounded';
        el.textContent = track.title;
        el.addEventListener('click', async () => {
          if (wavesurfer) {
            wavesurfer.destroy();
            if (current) current.classList.remove('active');
          }
          el.classList.add('active');
          current = el;
          wavesurfer = WaveSurfer.create({
            container: waveform,
            waveColor: '#999',
            progressColor: '#10b981',
            height: 96,
            barWidth: 2,
            responsive: true,
          });
          wavesurfer.load(track.file);
          wavesurfer.on('audioprocess', () => {
            const dur = wavesurfer.getDuration();
            const pos = wavesurfer.getCurrentTime();
            if (dur > 0) {
              const percent = (pos / dur) * 100;
              progress.style.width = `${percent}%`;
            }
          });
          wavesurfer.on('finish', () => {
            progress.style.width = '0%';
          });
        });
        trackList.appendChild(el);
      });

      return container;
    }

    async function init() {
      const files = await loadFiles();
      const selector = document.getElementById('playlist-selector');
      const activeContainer = document.getElementById('active-playlist');
      const otherContainer = document.getElementById('other-playlists');

      function renderPlaylistLinks(excludeIndex = null) {
        otherContainer.innerHTML = '';
        files.forEach((playlist, index) => {
          if (index !== excludeIndex) {
            const link = document.createElement('div');
            link.className = 'playlist-link';
            link.textContent = playlist.playlist;
            link.addEventListener('click', () => {
              activeContainer.innerHTML = '';
              const active = createPlaylist(playlist.playlist, playlist.tracks);
              activeContainer.appendChild(active);
              renderPlaylistLinks(index);
              window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            otherContainer.appendChild(link);
          }
        });
      }

      files.forEach((playlist, index) => {
        const link = document.createElement('div');
        link.className = 'playlist-link';
        link.textContent = playlist.playlist;
        link.addEventListener('click', () => {
          activeContainer.innerHTML = '';
          const active = createPlaylist(playlist.playlist, playlist.tracks);
          activeContainer.appendChild(active);
          renderPlaylistLinks(index);
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        selector.appendChild(link);
      });
    }

    init();
  </script>
</body>
</html>
