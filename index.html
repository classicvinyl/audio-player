<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Audio Player</title>
  <script src="https://unpkg.com/wavesurfer.js"></script>
  <style>
    body {
      background-color: #2a2a2a;
      font-family: sans-serif;
      color: white;
      margin: 0;
      padding: 20px;
    }
    .playlist {
      background-color: #121212;
      margin-bottom: 40px;
      padding: 20px;
      border-radius: 8px;
    }
    .playlist h2 {
      color: grey;
      margin-bottom: 20px;
    }
    .track {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    .track.active {
      background-color: #444;
    }
    .track svg {
      width: 30px;
      height: 30px;
      flex-shrink: 0;
    }
    .track span {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .waveform-container {
      margin-top: 20px;
      height: 100px;
      background-color: #121212;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    const filesUrl = 'files.json';
    let wavesurfer;
    let currentTrackEl = null;
    let currentPlayBtn = null;

    const playSVG = `
      <svg fill="white" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
    `;
    const pauseSVG = `
      <svg fill="white" viewBox="0 0 24 24"><rect x="6" y="5" width="4" height="14"/><rect x="14" y="5" width="4" height="14"/></svg>
    `;

    async function init() {
      const res = await fetch(filesUrl);
      const data = await res.json();

      const app = document.getElementById('app');

      data.forEach((playlist, playlistIndex) => {
        const container = document.createElement('div');
        container.className = 'playlist';

        const header = document.createElement('h2');
        header.textContent = playlist.playlist;
        container.appendChild(header);

        const waveContainer = document.createElement('div');
        waveContainer.className = 'waveform-container';
        waveContainer.id = `waveform-${playlistIndex}`;
        container.appendChild(waveContainer);

        playlist.tracks.forEach((track, index) => {
          const trackEl = document.createElement('div');
          trackEl.className = 'track';

          const btn = document.createElement('div');
          btn.innerHTML = playSVG;

          const name = document.createElement('span');
          name.textContent = track.title;

          trackEl.appendChild(btn);
          trackEl.appendChild(name);
          container.appendChild(trackEl);

          // Bind click separately to button and track name
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!wavesurfer || currentTrackEl !== trackEl) return;
            if (wavesurfer.isPlaying()) {
              wavesurfer.pause();
              btn.innerHTML = playSVG;
            } else {
              wavesurfer.play();
              btn.innerHTML = pauseSVG;
            }
          });

          name.addEventListener('click', () => {
            if (currentTrackEl) currentTrackEl.classList.remove('active');
            if (currentPlayBtn) currentPlayBtn.innerHTML = playSVG;
            trackEl.classList.add('active');
            currentTrackEl = trackEl;
            currentPlayBtn = btn;

            if (wavesurfer) wavesurfer.destroy();

            wavesurfer = WaveSurfer.create({
              container: `#waveform-${playlistIndex}`,
              waveColor: 'white',
              progressColor: 'orange',
              height: 100,
            });

            wavesurfer.load(track.file);

            wavesurfer.on('ready', () => {
              wavesurfer.play();
              btn.innerHTML = pauseSVG;
            });

            wavesurfer.on('finish', () => {
              btn.innerHTML = playSVG;
            });
          });

          // Auto preload the first track of each playlist
          if (index === 0) {
            setTimeout(() => name.click(), 0);
          }
        });

        app.appendChild(container);
      });
    }

    init();
  </script>
</body>
</html>
