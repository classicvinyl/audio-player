<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Audio Player</title>
  <script src="https://unpkg.com/wavesurfer.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-white font-sans p-4">
  <div id="main-container" class="max-w-4xl mx-auto space-y-6"></div>

  <script>
    const mainContainer = document.getElementById('main-container');
    let wavesurfer = null;
    let currentPlaylist = null;
    let currentTrackIndex = 0;

    fetch('files.json')
      .then(response => response.json())
      .then(data => renderPlaylistSelector(data));

    function renderPlaylistSelector(playlists) {
      mainContainer.innerHTML = '';
      const playlistList = document.createElement('div');
      playlistList.className = 'space-y-2';

      playlists.forEach((playlistData) => {
        const btn = document.createElement('button');
        btn.textContent = playlistData.playlist;
        btn.className = 'w-full text-left text-lg font-semibold border border-white p-4 hover:bg-white hover:text-black transition';
        btn.addEventListener('click', () => loadPlaylistView(playlistData, playlists));
        playlistList.appendChild(btn);
      });

      mainContainer.appendChild(playlistList);
    }

    function loadPlaylistView(selectedPlaylist, allPlaylists) {
      mainContainer.innerHTML = '';
      currentPlaylist = selectedPlaylist;
      currentTrackIndex = 0;

      const playerSection = document.createElement('div');
      playerSection.className = 'space-y-4';

      const header = document.createElement('div');
      header.className = 'flex justify-between items-center border-b border-white pb-2';
      header.innerHTML = `
        <h2 class="text-2xl font-bold">${selectedPlaylist.playlist}</h2>
        <button id="playPauseBtn" class="border border-white px-3 py-1 rounded hover:bg-white hover:text-black transition">Play</button>
      `;

      const waveform = document.createElement('div');
      waveform.id = 'waveform';
      waveform.className = 'w-full h-24 bg-gray-800';

      const progress = document.createElement('div');
      progress.id = 'progress';
      progress.className = 'text-sm italic';

      const trackList = document.createElement('ul');
      trackList.id = 'trackList';
      trackList.className = 'space-y-1';

      selectedPlaylist.tracks.forEach((track, index) => {
        const li = document.createElement('li');
        li.textContent = track.title;
        li.className = 'cursor-pointer px-2 py-1 hover:bg-white hover:text-black transition' + (index === 0 ? ' font-semibold' : '');
        li.addEventListener('click', () => {
          currentTrackIndex = index;
          loadTrack(track.file);
          highlightCurrentTrack(index);
        });
        trackList.appendChild(li);
      });

      playerSection.appendChild(header);
      playerSection.appendChild(waveform);
      playerSection.appendChild(progress);
      playerSection.appendChild(trackList);
      mainContainer.appendChild(playerSection);

      const remaining = allPlaylists.filter(p => p.playlist !== selectedPlaylist.playlist);
      if (remaining.length > 0) {
        const remainingHeader = document.createElement('h3');
        remainingHeader.className = 'text-lg font-bold pt-6';
        remainingHeader.textContent = 'Other Playlists';
        mainContainer.appendChild(remainingHeader);

        remaining.forEach(playlist => {
          const btn = document.createElement('button');
          btn.textContent = playlist.playlist;
          btn.className = 'w-full text-left text-lg font-semibold border border-white p-4 hover:bg-white hover:text-black transition mt-2';
          btn.addEventListener('click', () => loadPlaylistView(playlist, allPlaylists));
          mainContainer.appendChild(btn);
        });
      }

      setupWaveSurfer();
      loadTrack(selectedPlaylist.tracks[0].file);

      document.getElementById('playPauseBtn').addEventListener('click', () => {
        if (wavesurfer) {
          if (wavesurfer.isPlaying()) {
            wavesurfer.pause();
          } else {
            wavesurfer.play();
          }
        }
      });
    }

    function setupWaveSurfer() {
      if (wavesurfer) {
        wavesurfer.destroy();
      }

      wavesurfer = WaveSurfer.create({
        container: '#waveform',
        waveColor: '#999',
        progressColor: '#fff',
        height: 80,
      });

      wavesurfer.on('loading', percent => {
        const progress = document.getElementById('progress');
        if (progress) progress.textContent = `Loading: ${percent.toFixed(0)}%`;
      });

      wavesurfer.on('ready', () => {
        const progress = document.getElementById('progress');
        if (progress) progress.textContent = '';
      });

      wavesurfer.on('finish', () => {
        const nextIndex = currentTrackIndex + 1;
        if (currentPlaylist && nextIndex < currentPlaylist.tracks.length) {
          currentTrackIndex = nextIndex;
          loadTrack(currentPlaylist.tracks[currentTrackIndex].file);
          highlightCurrentTrack(currentTrackIndex);
        }
      });
    }

    function loadTrack(filePath) {
      wavesurfer.load(filePath);
    }

    function highlightCurrentTrack(index) {
      const listItems = document.querySelectorAll('#trackList li');
      listItems.forEach((li, i) => {
        li.classList.toggle('font-semibold', i === index);
      });
    }
  </script>
</body>
</html>
